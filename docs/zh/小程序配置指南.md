# 微信小程序二维码配置指南

## 📖 概述

本系统为每个推荐官生成两种二维码：

1. **网页版二维码** - 扫码后在浏览器中打开 H5 页面
2. **小程序版二维码** - 扫码后直接打开微信小程序（推荐）

## ✅ 已实现功能

- ✅ 微信 Access Token 自动获取和缓存
- ✅ 调用微信 API 生成真实小程序码
- ✅ Token 过期自动刷新机制
- ✅ 并发安全的 Token 缓存
- ✅ 详细的日志记录
- ✅ 完善的错误处理

---

## 🔧 配置步骤

### 步骤 1：获取小程序 AppID 和 AppSecret

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击左侧菜单 **"开发"** → **"开发管理"**
3. 点击 **"开发设置"** 标签页
4. 在 **"开发者ID"** 部分：
   - **AppID**：复制小程序 AppID
   - **AppSecret**：点击"生成"或"重置"按钮，获取密钥（⚠️ 只显示一次）

⚠️ **重要提醒：**
- AppSecret 只在生成时显示一次，请立即复制保存！
- AppSecret 类似于密码，不要泄露给他人
- 如果忘记了，只能重新生成，旧的会失效

### 步骤 2：配置环境变量

#### 方式 1：在 render.yaml 中配置（生产环境）

编辑 `render.yaml` 文件：

```yaml
envVars:
  # WeChat Mini Program Configuration
  - key: BASE_URL
    value: https://tourism-recommender-api.onrender.com  # 你的前端 URL
  
  - key: WX_APP_ID
    value: wxa1802e324f2f4712  # 替换为你的 AppID
  
  - key: WX_APP_SECRET
    value: a1b2c3d4e5f6g7h8i9j0  # 替换为你的 AppSecret
  
  - key: WX_APP_PATH
    value: pages/recommendor/detail  # 小程序页面路径
```

#### 方式 2：在 .env 文件中配置（开发环境）

在项目根目录创建 `.env` 文件：

```bash
# WeChat Mini Program
WX_APP_ID=wxa1802e324f2f4712
WX_APP_SECRET=a1b2c3d4e5f6g7h8i9j0
WX_APP_PATH=pages/recommendor/detail
BASE_URL=http://localhost:8080
```

### 步骤 3：部署应用

```bash
# 提交代码
git add .
git commit -m "Configure WeChat mini program"
git push

# Render 会自动部署
```

---

## 🧪 测试二维码

### 测试网页版二维码

1. 登录管理后台
2. 创建或编辑一个推荐官
3. 查看生成的"网页版二维码"
4. 使用手机微信扫描
5. 应该在微信浏览器中打开推荐官详情页面

### 测试小程序版二维码

1. 确保已配置 `WX_APP_SECRET`
2. 创建或编辑一个推荐官
3. 查看生成的"小程序版二维码"
4. 使用手机微信扫描
5. 应该直接打开小程序对应的页面（`pages/recommendor/detail?id=xxx`）

### 查看日志

如果二维码生成失败，可以查看应用日志：

```bash
# 在 Render 控制台查看实时日志
# 查找以下关键日志：
```

成功日志示例：
```
✅ Using cached access token (expires in: 1h45m)
✅ Successfully generated mini program QR code (size: 2345 bytes)
```

错误日志示例：
```
❌ WeChat API error [40001]: invalid credential
❌ Failed to generate Mini Program QR code: WeChat API error
```

---

## 🔐 安全注意事项

### ⚠️ 不要在代码中硬编码密钥

❌ **错误做法：**
```go
appSecret := "a1b2c3d4e5f6g7h8i9j0"  // 危险！
```

✅ **正确做法：**
```go
appSecret := os.Getenv("WX_APP_SECRET")
```

### 🔒 保护 AppSecret

1. **不要提交到 Git**
   - 将 `.env` 添加到 `.gitignore`
   - 使用环境变量管理敏感信息

2. **不要在公共平台泄露**
   - 不要在 GitHub Issues、Stack Overflow 等地方发布
   - 不要在截图、截屏中包含 AppSecret

3. **定期更换**
   - 如果怀疑泄露，立即在微信后台重置
   - 定期（如每半年）更换一次

---

## 🐛 常见问题

### 问题 1：二维码生成失败 - "invalid credential"

**错误信息：**
```
WeChat API error [40001]: invalid credential
```

**原因：**
- AppID 或 AppSecret 不正确
- AppSecret 已过期或被重置

**解决方法：**
1. 检查 `WX_APP_ID` 和 `WX_APP_SECRET` 是否正确
2. 登录微信公众平台重新生成 AppSecret
3. 更新环境变量并重新部署

---

### 问题 2：二维码生成失败 - "page not found"

**错误信息：**
```
WeChat API error [40163]: page not found
```

**原因：**
- 小程序页面路径不正确
- 小程序尚未发布该页面

**解决方法：**
1. 检查 `WX_APP_PATH` 配置是否正确
2. 确保小程序已发布并包含该页面
3. 或者在生成二维码时设置 `check_path: false`

---

### 问题 3：二维码显示为黑色方块

**原因：**
- 微信 API 返回了错误信息而非图片数据

**解决方法：**
1. 查看应用日志，获取详细的错误信息
2. 检查网络连接是否正常
3. 确认 AppID 和 AppSecret 是否正确

---

### 问题 4：Access Token 频繁过期

**现象：**
- 每次生成二维码都重新获取 Token
- 日志显示频繁调用微信 API

**原因：**
- Token 缓存时间设置过短

**说明：**
- 当前实现中，Token 在过期前 5 分钟就会刷新
- 这是正常行为，确保不会使用过期的 Token
- 微信 API 调用频率限制为每天 100 万次，一般不会超限

---

## 📊 实现原理

### Access Token 缓存机制

```
┌─────────────────────────────────────────┐
│  首次请求                                │
│  ↓                                      │
│  调用微信 API 获取 Token                │
│  ↓                                      │
│  缓存到内存（过期前 5 分钟刷新）         │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│  后续请求                                │
│  ↓                                      │
│  检查缓存中的 Token                     │
│  ↓                                      │
│  如果有效 → 直接使用                     │
│  如果过期 → 重新获取并缓存               │
└─────────────────────────────────────────┘
```

### 小程序码生成流程

```
1. 获取 Access Token（带缓存）
   ↓
2. 解析页面路径和参数
   page: pages/recommendor/detail
   scene: id=123
   ↓
3. 调用微信 API
   POST https://api.weixin.qq.com/wxa/getwxacodeunlimit
   ↓
4. 处理响应
   - 成功：返回图片数据（二进制）
   - 失败：返回 JSON 错误信息
   ↓
5. 转换为 Base64
   data:image/png;base64,...
```

---

## 📚 相关文档

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [获取小程序码 API](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html)
- [获取 Access Token API](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html)
- [微信登录流程](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

---

## 📞 获取帮助

如果遇到问题，请按以下步骤排查：

1. ✅ AppID 和 AppSecret 是否正确
2. ✅ 环境变量是否正确设置
3. ✅ Render 部署后是否使用了最新的环境变量
4. ✅ 小程序是否已发布
5. ✅ 查看应用日志，获取详细错误信息

如果以上步骤都无法解决问题，请查看官方文档或联系微信技术支持。