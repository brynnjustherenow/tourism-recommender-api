# 微信小程序测试版发布指南

## 📖 概述

小程序测试版（体验版）用于在正式发布前测试小程序功能。与开发版不同，体验版可以被其他用户（非开发者）访问。

## 🎯 测试版类型对比

| 类型 | 适用场景 | 访问权限 | 有效期 |
|------|---------|---------|--------|
| **开发版** | 开发者自己测试 | 仅开发者 | 实时生效 |
| **体验版** | 内部测试、客户演示 | 指定用户 | 30天 |
| **正式版** | 上线运营 | 所有微信用户 | 永久 |

---

## 🚀 发布流程

### 步骤 1：准备小程序代码

#### 使用微信开发者工具

1. **安装微信开发者工具**
   - 下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
   - 安装并使用微信扫码登录

2. **导入项目**
   - 点击"导入项目"或 "+" 按钮
   - 选择小程序代码目录
   - 填写项目名称
   - 填写 AppID（从微信公众平台获取）
   - 点击"导入"

3. **配置项目信息**
   
   在 `project.config.json` 中配置：
   ```json
   {
     "appid": "wxa1802e324f2f4712",
     "projectname": "tourism-recommender",
     "description": "乡村旅游推荐官小程序"
   }
   ```

4. **配置服务器域名**
   
   在 **微信公众平台** → **开发** → **开发管理** → **服务器域名** 配置：
   
   - **request 合法域名**：
     ```
     https://tourism-recommender-api.onrender.com
     ```
   
   - **uploadFile 合法域名**：
     ```
     https://tourism-recommender-api.onrender.com
     ```
   
   - **downloadFile 合法域名**：
     ```
     https://tourism-recommender-api.onrender.com
     ```
   
   ⚠️ **注意：**
   - 域名必须是 HTTPS
   - 域名需要在 ICP 备案（中国大陆）
   - 每个域名每月最多修改 5 次

### 步骤 2：本地测试

1. **编译项目**
   - 点击工具栏的"编译"按钮
   - 或使用快捷键 `Ctrl + B` (Windows) / `Cmd + B` (Mac)

2. **真机调试**
   - 点击"真机调试"
   - 使用手机微信扫码预览
   - 可以在真实设备上测试功能

3. **检查 API 调用**
   - 确保后端 API 地址正确
   - 检查网络请求是否正常
   - 查看控制台是否有错误

### 步骤 3：上传代码

1. **点击上传**
   - 点击工具栏的"上传"按钮
   - 或使用快捷键 `Ctrl + Shift + U` (Windows) / `Cmd + Shift + U` (Mac)

2. **填写版本信息**
   - **项目版本号**：例如 `1.0.0` 或 `1.0.0.test1`
   - **版本备注**：描述本次更新的内容
     ```
     - 添加推荐官详情页
     - 优化用户体验
     - 修复登录问题
     ```

3. **等待上传完成**
   - 上传成功后会提示"上传成功"
   - 可以在版本管理中查看上传记录

### 步骤 4：设置为体验版

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com/
   - 使用小程序账号登录

2. **进入版本管理**
   - 点击左侧菜单 **"管理"** → **"版本管理"**

3. **设置体验版**
   - 在"开发版本"或"体验版本"标签页
   - 找到刚上传的版本
   - 点击右侧的 **"选为体验版本"** 按钮
   - 系统会自动生成体验版二维码

### 步骤 5：配置体验版权限

1. **设置体验者**
   - 点击 **"管理体验成员"**
   - 输入体验者的微信号
   - 点击"添加"
   - 体验者会收到邀请通知

2. **获取体验版二维码**
   - 点击 **"体验版二维码"**
   - 扫描二维码即可体验测试版本

---

## 📱 体验版使用方法

### 方式一：通过二维码

1. 扫描体验版二维码
2. 微信会打开小程序（带"体验版"标识）
3. 正常使用小程序功能

### 方式二：通过微信开发者工具

1. 打开微信开发者工具
2. 点击"项目" → "体验版"
3. 选择对应的体验版版本
4. 在模拟器中预览或真机调试

### 方式三：通过版本管理入口

1. 登录微信公众平台
2. 进入 **"版本管理"** → **"体验版本"**
3. 点击 **"体验二维码"**
4. 扫码体验

---

## 🔄 更新体验版

### 场景 1：修改代码后更新

1. 在微信开发者工具中修改代码
2. 点击"编译"测试
3. 点击"上传"（使用新的版本号）
4. 在微信公众平台 **"选为体验版本"**

### 场景 2：修改配置后更新

1. 修改小程序配置文件
2. 上传新版本
3. 设置为体验版本

### 场景 3：回退到旧版本

1. 进入 **"版本管理"** → **"开发版本"**
2. 找到历史版本
3. 点击 **"选为体验版本"**

---

## ⚙️ 配置注意事项

### 1. 网络域名配置

在 **微信公众平台** → **开发** → **开发管理** → **服务器域名**：

```
request 合法域名：
https://tourism-recommender-api.onrender.com

uploadFile 合法域名：
https://tourism-recommender-api.onrender.com

downloadFile 合法域名：
https://tourism-recommender-api.onrender.com
```

⚠️ **重要：**
- 域名必须是 HTTPS
- 体验版可以使用 HTTP，但正式版必须是 HTTPS
- 域名需要 ICP 备案

### 2. 业务域名

如果小程序需要打开外部网页，需要配置业务域名：

```
业务域名：
https://tourism-recommender-api.onrender.com
```

### 3. 隐私设置

在 **"管理"** → **"用户隐私保护指引"** 中配置：
- 获取用户位置
- 获取手机号
- 其他敏感信息

---

## 🐛 常见问题

### 问题 1：上传失败

**错误信息：**
```
上传失败，请检查网络连接
```

**解决方法：**
1. 检查网络连接
2. 重新登录微信开发者工具
3. 尝试关闭并重新打开开发者工具
4. 检查项目配置是否正确

---

### 问题 2：二维码扫描后提示"页面不存在"

**错误信息：**
```
错误：页面不存在
```

**原因：**
- 体验版的小程序页面路径与开发版不一致
- 小程序代码没有正确上传

**解决方法：**
1. 检查小程序代码中的页面路径
2. 确认小程序代码已上传
3. 查看版本管理中的上传记录
4. 重新上传并设置为体验版

---

### 问题 3：API 请求失败

**错误信息：**
```
request:fail url not in domain list
```

**原因：**
- API 域名未在微信公众平台配置
- 域名不是 HTTPS

**解决方法：**
1. 登录微信公众平台
2. 进入 **"开发"** → **"开发管理"** → **"服务器域名"**
3. 添加后端 API 域名到 request 合法域名列表
4. 重新体验小程序

---

### 问题 4：体验版无法访问

**现象：**
- 扫描二维码后提示"该小程序已失效"
- 或提示"不是体验者"

**解决方法：**
1. 确认是否已设置为体验版本
2. 添加测试用户的微信号为体验成员
3. 让测试用户接受邀请
4. 重新生成体验版二维码

---

### 问题 5：体验版与开发版不一致

**现象：**
- 体验版功能与开发工具中看到的版本不同

**解决方法：**
1. 确认上传的版本是最新的
2. 检查版本号是否正确
3. 重新上传代码
4. 等待几分钟让微信服务器同步

---

## 📊 体验版与正式版对比

| 特性 | 体验版 | 正式版 |
|------|--------|--------|
| 访问范围 | 仅体验成员 | 所有微信用户 |
| 有效期 | 30天 | 永久 |
| 域名要求 | HTTP 或 HTTPS | 必须 HTTPS |
| 审核要求 | 不需要 | 需要审核通过 |
| 搜索显示 | 不会出现在搜索结果 | 可以被搜索到 |
| 分享 | 可以分享给体验成员 | 可以分享给所有人 |
| 支付功能 | 可以测试支付 | 需要正式认证 |

---

## 🎓 最佳实践

### 1. 版本号规范

```
格式：主版本号.次版本号.修订号

示例：
1.0.0      - 初始版本
1.0.1      - 修复 bug
1.1.0      - 添加新功能
2.0.0      - 重大更新
1.0.0.test1 - 测试版本
1.0.0.beta1 - 测试版本
```

### 2. 版本备注模板

```
版本号：1.0.0.test1
更新时间：2024-01-15
更新内容：
- [新增] 推荐官详情页面
- [优化] 登录流程
- [修复] 图片上传问题
已知问题：
- 二维码生成功能待测试
```

### 3. 测试流程建议

```
1. 开发者本地测试
   ↓
2. 真机调试测试
   ↓
3. 上传为体验版
   ↓
4. 内部测试人员体验
   ↓
5. 修复发现的问题
   ↓
6. 重新上传体验版
   ↓
7. 测试通过后提交审核
   ↓
8. 审核通过后发布正式版
```

### 4. 测试清单

- [ ] 登录功能正常
- [ ] 推荐官列表显示正常
- [ ] 推荐官详情页正常
- [ ] 目的地列表显示正常
- [ ] 目的地详情页正常
- [ ] 图片上传功能正常
- [ ] 网络请求正常
- [ ] 页面跳转正常
- [ ] 表单提交正常
- [ ] 错误处理正常

---

## 📞 获取帮助

### 官方文档

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [版本管理](https://developers.weixin.qq.com/miniprogram/dev/framework/operating/version.html)
- [服务器域名配置](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html)

### 常见问题

如果遇到问题，请按以下步骤排查：

1. ✅ 检查微信开发者工具版本（建议使用最新版）
2. ✅ 检查网络连接
3. ✅ 检查 AppID 是否正确
4. ✅ 检查项目配置文件
5. ✅ 查看控制台错误信息
6. ✅ 查看微信公众平台的通知消息
7. ✅ 尝试重新上传代码

### 技术支持

- 微信开放社区：https://developers.weixin.qq.com/community/
- 客服电话：95017

---

## 📝 附录

### A. project.config.json 示例

```json
{
  "miniprogramRoot": "./",
  "cloudfunctionRoot": "./cloudfunction/",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "postcss": true,
    "minified": true,
    "newFeature": true
  },
  "appid": "wxa1802e324f2f4712",
  "projectname": "tourism-recommender",
  "description": "乡村旅游推荐官小程序",
  "condition": {
    "search": {
      "list": []
    },
    "conversation": {
      "list": []
    },
    "game": {
      "list": []
    },
    "plugin": {
      "list": []
    },
    "gamePlugin": {
      "list": []
    },
    "miniprogram": {
      "list": []
    }
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "appid": "wxa1802e324f2f4712"
}
```

### B. 版本管理页面路径

```
微信公众平台 → 管理 → 版本管理 → 开发版本/体验版本
```

### C. 服务器域名配置页面路径

```
微信公众平台 → 开发 → 开发管理 → 开发设置 → 服务器域名
```

---

## ✅ 总结

发布小程序测试版的完整流程：

```
1. 准备代码
   ↓
2. 微信开发者工具导入项目
   ↓
3. 本地测试和真机调试
   ↓
4. 上传代码
   ↓
5. 在微信公众平台设置为体验版本
   ↓
6. 配置体验成员
   ↓
7. 分享体验版二维码
   ↓
8. 收集反馈并修复问题
   ↓
9. 重新上传体验版
   ↓
10. 测试通过后提交审核
```

记住：体验版是正式发布前的重要环节，充分利用它来发现和修复问题！🎉